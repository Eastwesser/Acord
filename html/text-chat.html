<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Текстовый и голосовой чат</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
<div id="chat-container">
    <div id="participants">
        <h2>Участники</h2>
        <ul id="participant-list">
            <!-- Здесь будет список участников -->
        </ul>
        <button id="voiceChatButton" onclick="startVoiceChat()">Подключиться к голосовому чату</button>
        <button id="connect-button">Подключиться к голосовому чату</button>

        <script>
            let localStream;
            let peerConnection;

            const wsVoice = new WebSocket("ws://localhost:8000/ws/voice");

            wsVoice.onopen = function () {
                console.log("Подключение к голосовому чату установлено.");
                document.getElementById("connect-button").textContent = "Подключено";
            };

            wsVoice.onmessage = async function (event) {
                const message = JSON.parse(event.data);
                console.log("Получено сообщение:", message);
                // Обработка сообщений
            };

            async function startVoiceChat() {
                localStream = await navigator.mediaDevices.getUserMedia({audio: true});
                peerConnection = new RTCPeerConnection({
                    iceServers: [{urls: "stun:stun.l.google.com:19302"}]
                });

                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        wsVoice.send(JSON.stringify({
                            type: "ice-candidate",
                            candidate: event.candidate
                        }));
                    }
                };

                peerConnection.ontrack = event => {
                    const remoteAudio = new Audio();
                    remoteAudio.srcObject = event.streams[0];
                    remoteAudio.play();
                };

                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);

                wsVoice.send(JSON.stringify({
                    type: "offer",
                    offer: offer
                }));
            }

            document.getElementById("connect-button").addEventListener("click", () => {
                startVoiceChat();
            });
        </script>

    </div>
    <div id="chat">
        <div id="chat-window"></div>
        <div id="message-input-container">
            <input id="messageInput" type="text" placeholder="Введите сообщение">
            <button onclick="sendMessage()">Отправить</button>
        </div>
    </div>
</div>

<script src="/js/text-chat.js"></script>
<script src="/js/voice-chat.js"></script>
</body>
</html>
